{% extends 'Tienda/base_layout.html' %}

{% block content %}
<div class="container mt-4">
    <!-- Barra de búsqueda -->
    <div class="row mb-4">
        <div class="col-md-6">
            <form method="GET" action="{% url 'gestionar_productos' %}">
                <div class="input-group">
                    <input type="text" class="form-control" name="q" value="{{ query }}" placeholder="Buscar productos...">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
        {% if es_superadmin %}
        <div class="col-md-6 text-end">
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#agregarModal">
                <i class="fas fa-plus"></i> Agregar Producto
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Buscador y botón agregar -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Buscar producto...">
        </div>
        {% if user.is_superuser %}
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarModal">Agregar Producto</button>
        </div>
        {% endif %}
    </div>

    <!-- Tabla de productos -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Código</th>
                    <th>Stock</th>
                    <th>Precio</th>
                    <th>Costo</th>
                    <th>Stock Mín.</th>
                    {% if es_superadmin %}
                    <th class="text-end">Acciones</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for producto in productos %}
                <tr class="producto-row" data-id="{{ producto.id }}"
                    data-nombre="{{ producto.nombre }}"
                    data-codigo_barras="{{ producto.codigo_barras }}"
                    data-stock="{{ producto.stock }}"
                    data-precio="{{ producto.precio }}"
                    data-costo="{{ producto.costo }}"
                    data-minimal_stock="{{ producto.minimal_stock }}">
                    <td>{{ producto.nombre }}</td>
                    <td>{{ producto.codigo_barras }}</td>
                    <td>{{ producto.stock }}</td>
                    <td>${{ producto.precio|floatformat:0 }}</td>
                    <td>${{ producto.costo|floatformat:0 }}</td>
                    <td>{{ producto.minimal_stock }}</td>
                    {% if es_superadmin %}
                    <td class="text-end">
                        <button class="btn btn-sm btn-warning editar-btn" data-id="{{ producto.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger borrar-btn ms-1" data-id="{{ producto.id }}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modales (solo para superadmin) -->
{% if es_superadmin %}
<!-- Modal Agregar -->
<div class="modal fade" id="agregarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Agregar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="agregarForm" method="POST" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" name="nombre" id="agregar-nombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Código de Barras</label>
                        <input type="text" class="form-control" name="codigo_barras" id="agregar-codigo_barras" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" name="stock" id="agregar-stock" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio</label>
                        <input type="number" class="form-control" name="precio" id="agregar-precio" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Costo</label>
                        <input type="number" class="form-control" name="costo" id="agregar-costo" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock Mínimo</label>
                        <input type="number" class="form-control" name="minimal_stock" id="agregar-minimal_stock" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar Producto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Editar -->
<div class="modal fade" id="editarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editarForm" method="POST" action="">
                {% csrf_token %}
                <input type="hidden" name="producto_id" id="editar-producto-id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" name="nombre" id="editar-nombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Código de Barras</label>
                        <input type="text" class="form-control" name="codigo_barras" id="editar-codigo_barras" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" name="stock" id="editar-stock" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio</label>
                        <input type="number" class="form-control" name="precio" id="editar-precio" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Costo</label>
                        <input type="number" class="form-control" name="costo" id="editar-costo" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock Mínimo</label>
                        <input type="number" class="form-control" name="minimal_stock" id="editar-minimal_stock" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filtro de búsqueda en tiempo real
    const searchInput = document.getElementById('searchInput');
    const tableRows = document.querySelectorAll('#tabla-productos tbody tr');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        tableRows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            row.style.display = rowText.includes(searchTerm) ? '' : 'none';
        });
    });

    // Modal agregar producto: limpiar campos al abrir
    const agregarModal = document.getElementById('agregarModal');
    if (agregarModal) {
        agregarModal.addEventListener('show.bs.modal', function() {
            this.querySelector('form').reset();
        });
    }

    // Manejo de agregar producto vía AJAX
    const agregarForm = document.getElementById('agregarForm');
    if (agregarForm) {
        agregarForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('{% url "gestionar_productos" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo agregar el producto.'));
                }
            })
            .catch(error => {
                alert('Error al agregar producto: ' + error);
            });
        });
    }

    // Manejo de editar producto vía AJAX
    document.querySelectorAll('.editar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            fetch(`{% url 'gestionar_productos' %}?get_producto=${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Rellenar el formulario de edición con los datos recibidos
                        const editModal = new bootstrap.Modal(document.getElementById('editarModal'));
                        document.getElementById('editar-producto-id').value = data.producto.id;
                        document.getElementById('editar-nombre').value = data.producto.nombre;
                        document.getElementById('editar-codigo').value = data.producto.codigo;
                        document.getElementById('editar-stock').value = data.producto.stock;
                        document.getElementById('editar-precio').value = data.producto.precio;
                        document.getElementById('editar-costo').value = data.producto.costo;
                        document.getElementById('editar-stock-minimo').value = data.producto.stock_minimo;
                        editModal.show();
                    } else {
                        alert('No se pudo cargar el producto.');
                    }
                });
        });
    });
    const editarForm = document.getElementById('editarForm');
    if (editarForm) {
        editarForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('{% url "gestionar_productos" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo editar el producto.'));
                }
            })
            .catch(error => {
                alert('Error al editar producto: ' + error);
            });
        });
    }

    // Manejo de eliminar producto vía AJAX
    document.querySelectorAll('.borrar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!confirm('¿Está seguro de que desea eliminar este producto?')) return;
            const id = this.dataset.id;
            fetch('{% url "gestionar_productos" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ delete_producto: id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar el producto.'));
                }
            })
            .catch(error => {
                alert('Error al eliminar producto: ' + error);
            });
        });
    });
});
</script>
{% endblock %}