{% extends 'Tienda/base_layout.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4"><i class="fas fa-truck me-2"></i>Gestionar Proveedores</h2>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-search me-2"></i>Buscar Proveedores</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group mb-3">
                        <input type="text" id="buscar-proveedor" class="form-control" placeholder="Buscar por nombre, dirección, teléfono o email...">
                        <button class="btn btn-primary" type="button" id="btn-buscar">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                    <small class="text-muted">La búsqueda se realiza en tiempo real mientras escribes</small>
                </div>
                <div class="col-md-4">
                    <select id="filtro-proveedor" class="form-select">
                        <option value="">Todos los proveedores</option>
                        <option value="con-email">Con email</option>
                        <option value="sin-email">Sin email</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Listado de Proveedores</h5>
        </div>
        <div class="card-body">
            <!-- Botón para añadir nuevo proveedor (Modal) -->
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#nuevoProveedorModal">
                <i class="fas fa-plus-circle me-2"></i>Añadir Proveedor
            </button>

            <!-- Tabla de Proveedores -->
            <div class="table-responsive">
                <table class="table table-hover" id="tabla-proveedores">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Dirección</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proveedor in proveedores %}
                        <tr class="fila-proveedor" data-nombre="{{ proveedor.nombre_proveedor|lower }}" data-direccion="{{ proveedor.direccion|lower }}" data-telefono="{{ proveedor.telefono }}" data-email="{{ proveedor.email|default:'' }}">
                            <td>{{ proveedor.nombre_proveedor }}</td>
                            <td>{{ proveedor.direccion }}</td>
                            <td>{{ proveedor.telefono }}</td>
                            <td>{{ proveedor.email|default:"N/A" }}</td>
                            <td>
                                <!-- Acciones para proveedores (editar, eliminar) -->
                                <button class="btn btn-sm btn-warning editar-proveedor" data-id="{{ proveedor.id }}" data-nombre="{{ proveedor.nombre_proveedor }}" data-direccion="{{ proveedor.direccion }}" data-telefono="{{ proveedor.telefono }}" data-email="{{ proveedor.email|default:'' }}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger eliminar-proveedor" data-id="{{ proveedor.id }}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="no-resultados">
                            <td colspan="5" class="text-center">No hay proveedores registrados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end mt-3">
        <a href="{% url 'home' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
        </a>
    </div>
</div>

<!-- Modal para Nuevo/Editar Proveedor -->
<div class="modal fade" id="nuevoProveedorModal" tabindex="-1" aria-labelledby="nuevoProveedorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="nuevoProveedorModalLabel"><i class="fas fa-plus-circle me-2"></i>Añadir Nuevo Proveedor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-proveedor" method="post" action="{% url 'gestionar_proveedores' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_proveedor" id="proveedor-action">
                    <input type="hidden" name="proveedor_id" id="proveedor-id">
                    <div class="mb-3">
                        <label for="nombre_proveedor" class="form-label">Nombre del Proveedor</label>
                        <input type="text" class="form-control" id="nombre_proveedor" name="nombre_proveedor" required>
                    </div>
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" required>
                    </div>
                    <div class="mb-3">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="telefono" name="telefono" required pattern="[0-9]+">
                        <div class="form-text">Solo números, sin espacios ni guiones.</div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email (Opcional)</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="form-proveedor" class="btn btn-success" id="btn-guardar-proveedor">Guardar Proveedor</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const nuevoProveedorModal = new bootstrap.Modal(document.getElementById('nuevoProveedorModal'));
    const formProveedor = document.getElementById('form-proveedor');
    const proveedorActionInput = document.getElementById('proveedor-action');
    const proveedorIdInput = document.getElementById('proveedor-id');
    const modalTitle = document.getElementById('nuevoProveedorModalLabel');
    const btnGuardar = document.getElementById('btn-guardar-proveedor');
    const buscarInput = document.getElementById('buscar-proveedor');
    const filtroSelect = document.getElementById('filtro-proveedor');
    const btnBuscar = document.getElementById('btn-buscar');
    const tablaProveedores = document.getElementById('tabla-proveedores');
    const filasProveedores = document.querySelectorAll('.fila-proveedor');
    const noResultados = document.getElementById('no-resultados');

    // Función para mostrar/ocultar filas según búsqueda y filtro
    function filtrarProveedores() {
        const textoBusqueda = buscarInput.value.toLowerCase().trim();
        const filtro = filtroSelect.value;
        let hayResultados = false;

        // Obtener todas las filas de proveedores (para asegurar que estamos trabajando con la colección actualizada)
        const filasActuales = document.querySelectorAll('.fila-proveedor');

        filasActuales.forEach(fila => {
            const nombre = fila.dataset.nombre || '';
            const direccion = fila.dataset.direccion || '';
            const telefono = fila.dataset.telefono || '';
            const email = fila.dataset.email || '';
            
            // Aplicar filtro de email
            let pasaFiltroEmail = true;
            if (filtro === 'con-email' && !email) {
                pasaFiltroEmail = false;
            } else if (filtro === 'sin-email' && email) {
                pasaFiltroEmail = false;
            }
            
            // Aplicar búsqueda de texto
            const pasaBusqueda = textoBusqueda === '' || 
                nombre.includes(textoBusqueda) || 
                direccion.includes(textoBusqueda) || 
                telefono.includes(textoBusqueda) ||
                (email && email.includes(textoBusqueda));
            
            // Mostrar u ocultar fila
            if (pasaFiltroEmail && pasaBusqueda) {
                fila.style.display = '';
                hayResultados = true;
            } else {
                fila.style.display = 'none';
            }
        });

        // Mostrar mensaje si no hay resultados
        const noResultadosRow = document.getElementById('no-resultados');
        if (noResultadosRow) {
            if (hayResultados) {
                noResultadosRow.style.display = 'none';
            } else {
                noResultadosRow.style.display = '';
                const mensajeCell = noResultadosRow.querySelector('td');
                if (mensajeCell) {
                    mensajeCell.textContent = 'No se encontraron proveedores con los criterios de búsqueda.';
                }
            }
        }
    }

    // Eventos para filtrado y búsqueda
    if (btnBuscar) {
        btnBuscar.addEventListener('click', filtrarProveedores);
    }
    
    if (buscarInput) {
        // Filtrar en tiempo real mientras se escribe
        buscarInput.addEventListener('input', filtrarProveedores);
        
        // También mantener el evento de Enter por compatibilidad
        buscarInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                filtrarProveedores();
            }
        });
    }
    
    if (filtroSelect) {
        filtroSelect.addEventListener('change', filtrarProveedores);
    }

    // Resetear modal al abrir para añadir
    document.querySelector('[data-bs-target="#nuevoProveedorModal"]').addEventListener('click', () => {
        formProveedor.reset();
        proveedorActionInput.value = 'add_proveedor';
        proveedorIdInput.value = '';
        modalTitle.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Añadir Nuevo Proveedor';
        btnGuardar.textContent = 'Guardar Proveedor';
        btnGuardar.classList.remove('btn-warning');
        btnGuardar.classList.add('btn-success');
    });

    // Función para configurar los eventos de los botones de editar
    function configurarBotonesEditar() {
        // Primero eliminar los event listeners existentes para evitar duplicados
        document.querySelectorAll('.editar-proveedor').forEach(button => {
            button.replaceWith(button.cloneNode(true));
        });
        
        // Luego añadir los nuevos event listeners
        document.querySelectorAll('.editar-proveedor').forEach(button => {
            button.addEventListener('click', (event) => {
                const btn = event.currentTarget;
                const proveedorId = btn.dataset.id;
                const nombre = btn.dataset.nombre;
                const direccion = btn.dataset.direccion;
                const telefono = btn.dataset.telefono;
                const email = btn.dataset.email;
                
                // Llenar el formulario con los datos del proveedor
                document.getElementById('nombre_proveedor').value = nombre;
                document.getElementById('direccion').value = direccion;
                document.getElementById('telefono').value = telefono;
                document.getElementById('email').value = email || '';
                
                // Configurar el formulario para edición
                proveedorActionInput.value = 'edit_proveedor';
                proveedorIdInput.value = proveedorId;
                modalTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Editar Proveedor';
                btnGuardar.textContent = 'Actualizar Proveedor';
                btnGuardar.classList.remove('btn-success');
                btnGuardar.classList.add('btn-warning');
                
                // Mostrar el modal
                nuevoProveedorModal.show();
            });
        });
    }
    
    // Inicializar los botones de editar
    configurarBotonesEditar();
    configurarBotonesEliminar();

    // La configuración de los botones de eliminar ahora se maneja en la función configurarBotonesEliminar()

    // Prevenir que el formulario redirija a home
    formProveedor.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validar el formulario
        if (!this.checkValidity()) {
            e.stopPropagation();
            this.classList.add('was-validated');
            return;
        }
        
        // Obtener los datos del formulario
        const formData = new FormData(this);
        const action = formData.get('action');
        const proveedorId = formData.get('proveedor_id');
        const nombre = formData.get('nombre_proveedor');
        const direccion = formData.get('direccion');
        const telefono = formData.get('telefono');
        const email = formData.get('email') || '';
        
        // Enviar los datos mediante fetch
        // Función para obtener el token CSRF de la cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // ¿Esta cookie comienza con el nombre que queremos?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        fetch(this.action, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error('Error al guardar el proveedor: ' + text);
                });
            }
        })
        .then(data => {
            // Cerrar el modal
            nuevoProveedorModal.hide();
            
            if (action === 'add_proveedor') {
                // Añadir nueva fila a la tabla
                const tbody = document.querySelector('#tabla-proveedores tbody');
                const noResultados = document.getElementById('no-resultados');
                // Si no hay resultados, ocultarlo
                if (noResultados) {
                    noResultados.style.display = 'none';
                }
                // Crear nueva fila
                const nuevaFila = document.createElement('tr');
                nuevaFila.className = 'fila-proveedor';
                nuevaFila.dataset.nombre = nombre.toLowerCase();
                nuevaFila.dataset.direccion = direccion.toLowerCase();
                nuevaFila.dataset.telefono = telefono;
                nuevaFila.dataset.email = email;
                nuevaFila.innerHTML = `
                    <td>${nombre}</td>
                    <td>${direccion}</td>
                    <td>${telefono}</td>
                    <td>${email || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning editar-proveedor" data-id="${data.proveedor.id}" data-nombre="${nombre}" data-direccion="${direccion}" data-telefono="${telefono}" data-email="${email}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger eliminar-proveedor" data-id="${data.proveedor.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(nuevaFila);
                // Configurar eventos para los nuevos botones
                configurarBotonesEditar();
                configurarBotonesEliminar();
            } else if (action === 'edit_proveedor') {
                // Actualizar fila existente
                const fila = document.querySelector(`button.editar-proveedor[data-id="${proveedorId}"]`).closest('tr');
                if (fila) {
                    // Actualizar datos de la fila
                    fila.dataset.nombre = nombre.toLowerCase();
                    fila.dataset.direccion = direccion.toLowerCase();
                    fila.dataset.telefono = telefono;
                    fila.dataset.email = email;
                    // Actualizar contenido visible
                    fila.cells[0].textContent = nombre;
                    fila.cells[1].textContent = direccion;
                    fila.cells[2].textContent = telefono;
                    fila.cells[3].textContent = email || 'N/A';
                    // Actualizar atributos de los botones
                    const btnEditar = fila.querySelector('.editar-proveedor');
                    btnEditar.dataset.nombre = nombre;
                    btnEditar.dataset.direccion = direccion;
                    btnEditar.dataset.telefono = telefono;
                    btnEditar.dataset.email = email;
                    // Reconfigurar los event listeners para asegurar que funcionen correctamente
                    configurarBotonesEditar();
                    configurarBotonesEliminar();
                }
            }
            
            // Mostrar mensaje de éxito
            alert(data.message || 'Operación completada con éxito');
            
            // Aplicar filtros actuales
            filtrarProveedores();
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    });
    
    // Función para manejar la eliminación de proveedores
    function eliminarProveedorHandler(event) {
        const proveedorId = event.currentTarget.dataset.id;
        if (confirm('¿Estás seguro de que deseas eliminar este proveedor?')) {
            // Crear FormData para enviar la solicitud POST
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('action', 'delete_proveedor');
            formData.append('proveedor_id', proveedorId);
            
            // Enviar solicitud mediante fetch
            fetch('{% url "gestionar_proveedores" %}', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Eliminar la fila de la tabla o recargar la página
                    const fila = event.currentTarget.closest('tr');
                    if (fila) {
                        fila.remove();
                        // Si no quedan filas, mostrar mensaje de no resultados
                        if (document.querySelectorAll('.fila-proveedor').length === 0) {
                            if (noResultados) {
                                noResultados.style.display = '';
                                noResultados.querySelector('td').textContent = 'No hay proveedores registrados.';
                            }
                        }
                        configurarBotonesEditar();
                        configurarBotonesEliminar();
                    } else {
                        window.location.reload();
                    }
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error('Error al eliminar el proveedor: ' + text);
                    });
                }
            })
            .then(data => {
                if (data && data.message) {
                    alert(data.message);
                }
                // Aplicar filtros actuales
                filtrarProveedores();
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    }
    
    // Configurar botones de eliminar
    function configurarBotonesEliminar() {
        // Primero eliminar los event listeners existentes para evitar duplicados
        document.querySelectorAll('.eliminar-proveedor').forEach(button => {
            button.replaceWith(button.cloneNode(true));
        });
        
        // Luego añadir los nuevos event listeners
        document.querySelectorAll('.eliminar-proveedor').forEach(button => {
            button.addEventListener('click', eliminarProveedorHandler);
        });
    }
    
    // Inicializar botones de eliminar
    configurarBotonesEliminar();
</script>
{% endblock %}