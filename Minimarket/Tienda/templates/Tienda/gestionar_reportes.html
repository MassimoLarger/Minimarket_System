{% extends 'Tienda/base_layout.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-line me-2"></i>Gestión de Reportes</h2>
        <a href="{% url 'home' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver al Inicio
        </a>
    </div>

    <div class="row">
        <!-- Panel de Control -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Crear Nuevo Reporte</h5>
                </div>
                <div class="card-body">
                    <form id="formCrearReporte">
                        <div class="mb-3">
                            <label for="nombreReporte" class="form-label">Nombre del Reporte</label>
                            <input type="text" class="form-control" id="nombreReporte" name="nombreReporte" required>
                        </div>
                        <div class="mb-3">
                            <label for="descripcionReporte" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcionReporte" name="descripcionReporte" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="tipoReporte" class="form-label">Tipo de Reporte</label>
                            <select class="form-select" id="tipoReporte" name="tipoReporte" onchange="mostrarCamposProducto()" required>
                                <option value="">Seleccionar tipo...</option>
                                <option value="producto">Producto</option>
                                <option value="perdida">Pérdida</option>
                            </select>
                        </div>
                        
                        <!-- Campos para productos (solo visible cuando tipo es 'producto' o 'perdida') -->
                        <div id="camposProducto" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Productos Afectados</label>
                                <div id="productosContainer">
                                    <div class="producto-item border rounded p-3 mb-2">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Producto</label>
                                                <select class="form-select producto-select" name="productos[]">
                                                    <option value="">Seleccionar producto...</option>
                                                    {% for producto in productos %}
                                                    <option value="{{ producto.id }}" data-stock="{{ producto.stock }}">{{ producto.nombre }} (Stock: {{ producto.stock }})</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Cantidad</label>
                                                <input type="number" class="form-control cantidad-input" name="cantidades[]" min="1">
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="button" class="btn btn-danger btn-sm remove-producto" onclick="removeProducto(this)" style="display: none;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12">
                                                <label class="form-label">Observaciones (opcional)</label>
                                                <input type="text" class="form-control" name="observaciones[]" placeholder="Detalles adicionales...">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="addProductoContainer" style="display: none;">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addProducto()">
                                        <i class="fas fa-plus me-1"></i> Agregar otro producto
                                    </button>
                                </div>
                                <small class="text-muted">Para pérdidas, estas cantidades se descontarán del stock</small>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-1"></i> Crear Reporte
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Lista de Reportes -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Reportes Existentes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Fecha Creación</th>
                                    <th>Usuario</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaReportes">
                                {% for reporte in reportes %}
                                <tr data-reporte-id="{{ reporte.id }}">
                                    <td><strong>{{ reporte.nombre_reporte }}</strong></td>
                                    <td>
                                        <span class="badge 
                                            {% if reporte.tipo == 'producto' %}bg-info
                                            {% elif reporte.tipo == 'perdida' %}bg-danger
                                            {% elif reporte.tipo == 'inventario' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ reporte.get_tipo_display }}
                                        </span>
                                    </td>
                                    <td>{{ reporte.fecha_creacion|date:"d/m/Y H:i" }}</td>
                                    <td>{{ reporte.usuario_creador.username }}</td>
                                    <td>
                                        <span class="badge {% if reporte.activo %}bg-success{% else %}bg-secondary{% endif %}">
                                            {% if reporte.activo %}Activo{% else %}Inactivo{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-info" onclick="verDetalleReporte({{ reporte.id }})" title="Ver Detalle">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" onclick="editarReporte({{ reporte.id }})" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-{% if reporte.activo %}secondary{% else %}success{% endif %}" 
                                                    onclick="toggleEstadoReporte({{ reporte.id }}, {{ reporte.activo|yesno:'true,false' }})" 
                                                    title="{% if reporte.activo %}Desactivar{% else %}Activar{% endif %}">
                                                <i class="fas fa-{% if reporte.activo %}pause{% else %}play{% endif %}"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" onclick="eliminarReporte({{ reporte.id }})" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        No hay reportes registrados
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalle del Reporte -->
<div class="modal fade" id="modalDetalleReporte" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Detalle del Reporte</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contenidoDetalleReporte">
                <!-- Contenido cargado dinámicamente -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Reporte -->
<div class="modal fade" id="modalEditarReporte" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Reporte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarReporte">
                    <input type="hidden" id="editReporteId" name="editReporteId">
                    <div class="mb-3">
                        <label for="editNombreReporte" class="form-label">Nombre del Reporte</label>
                        <input type="text" class="form-control" id="editNombreReporte" name="editNombreReporte" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescripcionReporte" class="form-label">Descripción</label>
                        <textarea class="form-control" id="editDescripcionReporte" name="editDescripcionReporte" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editTipoReporte" class="form-label">Tipo de Reporte</label>
                        <select class="form-select" id="editTipoReporte" name="editTipoReporte" onchange="mostrarCamposProductoEdit()" required>
                            <option value="producto">Producto</option>
                            <option value="perdida">Pérdida</option>
                        </select>
                    </div>
                    
                    <!-- Campos para productos en edición -->
                    <div id="camposProductoEdit" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Productos Afectados</label>
                            <div id="productosContainerEdit">
                                <div class="producto-item-edit mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <label class="form-label">Producto</label>
                                            <select class="form-select producto-select-edit" name="productos_edit[]">
                                                <option value="">Seleccionar producto...</option>
                                                {% for producto in productos %}
                                                <option value="{{ producto.id }}" data-stock="{{ producto.stock }}">{{ producto.nombre }} (Stock: {{ producto.stock }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Cantidad</label>
                                            <input type="number" class="form-control cantidad-input-edit" name="cantidades_edit[]" min="1" placeholder="Cantidad">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Observaciones</label>
                                            <input type="text" class="form-control observaciones-input-edit" name="observaciones_edit[]" placeholder="Opcional">
                                        </div>
                                        <div class="col-md-1 d-flex align-items-end">
                                            <button type="button" class="btn btn-danger btn-sm remove-producto-edit" onclick="removeProductoEdit(this)" style="display: none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="addProductoContainerEdit" style="display: none;">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addProductoEdit()">
                                    <i class="fas fa-plus me-1"></i>Agregar otro producto
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="confirmarEditarReporte()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Mostrar/ocultar campos de producto según el tipo seleccionado
function mostrarCamposProducto() {
    const tipo = document.getElementById('tipoReporte').value;
    const camposProducto = document.getElementById('camposProducto');
    const addProductoContainer = document.getElementById('addProductoContainer');
    
    if (tipo === 'producto' || tipo === 'perdida') {
        camposProducto.style.display = 'block';
        // Para reportes de pérdida, permitir múltiples productos
        if (tipo === 'perdida') {
            addProductoContainer.style.display = 'block';
            updateRemoveButtons();
        } else {
            addProductoContainer.style.display = 'none';
            // Para reportes de producto, mantener solo uno
            const productosContainer = document.getElementById('productosContainer');
            const items = productosContainer.querySelectorAll('.producto-item');
            for (let i = 1; i < items.length; i++) {
                items[i].remove();
            }
            updateRemoveButtons();
        }
        updateRequiredFields();
    } else {
        camposProducto.style.display = 'none';
        addProductoContainer.style.display = 'none';
    }
}

// Agregar nuevo producto (solo para pérdidas)
function addProducto() {
    const container = document.getElementById('productosContainer');
    const newItem = container.querySelector('.producto-item').cloneNode(true);
    
    // Limpiar valores del nuevo item
    newItem.querySelectorAll('select, input').forEach(field => {
        field.value = '';
    });
    
    container.appendChild(newItem);
    updateRemoveButtons();
    updateRequiredFields();
}

// Remover producto
function removeProducto(button) {
    const container = document.getElementById('productosContainer');
    if (container.querySelectorAll('.producto-item').length > 1) {
        button.closest('.producto-item').remove();
        updateRemoveButtons();
        updateRequiredFields();
    }
}

// Actualizar botones de remover
function updateRemoveButtons() {
    const container = document.getElementById('productosContainer');
    const items = container.querySelectorAll('.producto-item');
    const tipo = document.getElementById('tipoReporte').value;
    
    items.forEach((item, index) => {
        const removeBtn = item.querySelector('.remove-producto');
        // Mostrar botón de remover solo si hay más de un item y es reporte de pérdida
        if (items.length > 1 && tipo === 'perdida') {
            removeBtn.style.display = 'block';
        } else {
            removeBtn.style.display = 'none';
        }
    });
}

// Actualizar campos requeridos
function updateRequiredFields() {
    const tipo = document.getElementById('tipoReporte').value;
    const container = document.getElementById('productosContainer');
    
    if (tipo === 'producto' || tipo === 'perdida') {
        container.querySelectorAll('.producto-select').forEach(select => {
            select.required = true;
        });
        container.querySelectorAll('.cantidad-input').forEach(input => {
            input.required = true;
        });
    } else {
        container.querySelectorAll('.producto-select').forEach(select => {
            select.required = false;
        });
        container.querySelectorAll('.cantidad-input').forEach(input => {
            input.required = false;
        });
    }
}

function mostrarCamposProductoEdit() {
    const tipo = document.getElementById('editTipoReporte').value;
    const camposProducto = document.getElementById('camposProductoEdit');
    const addProductoContainer = document.getElementById('addProductoContainerEdit');
    
    if (tipo === 'producto' || tipo === 'perdida') {
        camposProducto.style.display = 'block';
        // Para reportes de pérdida, permitir múltiples productos
        if (tipo === 'perdida') {
            addProductoContainer.style.display = 'block';
            updateRemoveButtonsEdit();
        } else {
            addProductoContainer.style.display = 'none';
            // Para reportes de producto, mantener solo uno
            const productosContainer = document.getElementById('productosContainerEdit');
            const items = productosContainer.querySelectorAll('.producto-item-edit');
            for (let i = 1; i < items.length; i++) {
                items[i].remove();
            }
            updateRemoveButtonsEdit();
        }
        updateRequiredFieldsEdit();
    } else {
        camposProducto.style.display = 'none';
        addProductoContainer.style.display = 'none';
    }
}

// Agregar nuevo producto en edición (solo para pérdidas)
function addProductoEdit() {
    const container = document.getElementById('productosContainerEdit');
    const newItem = container.querySelector('.producto-item-edit').cloneNode(true);
    
    // Limpiar valores del nuevo item
    newItem.querySelectorAll('select, input').forEach(field => {
        field.value = '';
    });
    
    container.appendChild(newItem);
    updateRemoveButtonsEdit();
    updateRequiredFieldsEdit();
}

// Remover producto en edición
function removeProductoEdit(button) {
    const container = document.getElementById('productosContainerEdit');
    if (container.querySelectorAll('.producto-item-edit').length > 1) {
        button.closest('.producto-item-edit').remove();
        updateRemoveButtonsEdit();
        updateRequiredFieldsEdit();
    }
}

// Actualizar botones de remover en edición
function updateRemoveButtonsEdit() {
    const container = document.getElementById('productosContainerEdit');
    const items = container.querySelectorAll('.producto-item-edit');
    const tipo = document.getElementById('editTipoReporte').value;
    
    items.forEach((item, index) => {
        const removeBtn = item.querySelector('.remove-producto-edit');
        // Mostrar botón de remover solo si hay más de un item y es reporte de pérdida
        if (items.length > 1 && tipo === 'perdida') {
            removeBtn.style.display = 'block';
        } else {
            removeBtn.style.display = 'none';
        }
    });
}

// Actualizar campos requeridos en edición
function updateRequiredFieldsEdit() {
    const tipo = document.getElementById('editTipoReporte').value;
    const container = document.getElementById('productosContainerEdit');
    
    if (tipo === 'producto' || tipo === 'perdida') {
        container.querySelectorAll('.producto-select-edit').forEach(select => {
            select.required = true;
        });
        container.querySelectorAll('.cantidad-input-edit').forEach(input => {
            input.required = true;
        });
    } else {
        container.querySelectorAll('.producto-select-edit').forEach(select => {
            select.required = false;
        });
        container.querySelectorAll('.cantidad-input-edit').forEach(input => {
            input.required = false;
        });
    }
}

// Funciones auxiliares para SweetAlert2
function showSwalSuccess(message) {
    Swal.fire({
        icon: 'success',
        title: 'Éxito',
        text: message,
        timer: 1500,
        showConfirmButton: false
    });
}

function showSwalError(message) {
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: message,
        timer: 3000,
        showConfirmButton: true
    });
}

// Crear nuevo reporte
document.getElementById('formCrearReporte').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Usar el sistema de validación personalizado
    if (!validateSpecificForm('formCrearReporte')) {
        return;
    }
    
    const tipo = document.getElementById('tipoReporte').value;
    const nombreReporte = document.getElementById('nombreReporte').value.trim();
    const descripcionReporte = document.getElementById('descripcionReporte').value.trim();
    
    // Las validaciones básicas se manejan por el sistema de validación personalizado
    
    const formData = {
        action: 'crear_reporte',
        nombre_reporte: nombreReporte,
        descripcion: descripcionReporte,
        tipo: tipo,
        productos: []
    };
    
    // Recopilar datos de productos
    if (tipo === 'perdida' || tipo === 'producto') {
        const container = document.getElementById('productosContainer');
        const items = container.querySelectorAll('.producto-item');
        
        for (let item of items) {
            const productoSelect = item.querySelector('.producto-select');
            const cantidadInput = item.querySelector('.cantidad-input');
            const observacionesInput = item.querySelector('input[name="observaciones[]"]');
            
            const productoId = productoSelect.value;
            const cantidad = cantidadInput.value;
            const observaciones = observacionesInput.value;
            
            if (productoId && cantidad) {
                formData.productos.push({
                    producto_id: productoId,
                    cantidad: cantidad,
                    observaciones: observaciones || ''
                });
            }
        }
        
        // Los productos se validarán en el servidor
    }
    
    fetch('{% url "gestionar_reportes" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSwalSuccess(data.message);
            // Limpiar formulario
            document.getElementById('formCrearReporte').reset();
            document.getElementById('camposProducto').style.display = 'none';
            setTimeout(() => location.reload(), 1500);
        } else {
            if (data.error_type === 'unique_constraint') {
                showUniqueConstraintError(data.message, data.field);
            } else {
                showSwalError(data.message || 'Error al crear el reporte');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSwalError(error.message || 'Ocurrió un error al crear el reporte.');
    });
});

// Ver detalle del reporte
function verDetalleReporte(reporteId) {
    fetch(`{% url "gestionar_reportes" %}?action=get&id=${reporteId}`)
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const reporte = data.reporte;
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><strong>Nombre:</strong></h6>
                        <p>${reporte.nombre}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><strong>Tipo:</strong></h6>
                        <p><span class="badge ${
                            reporte.tipo === 'producto' ? 'bg-info' :
                            reporte.tipo === 'perdida' ? 'bg-danger' :
                            reporte.tipo === 'inventario' ? 'bg-warning' : 'bg-secondary'
                        }">${reporte.tipo.charAt(0).toUpperCase() + reporte.tipo.slice(1)}</span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6><strong>Descripción:</strong></h6>
                        <p>${reporte.descripcion}</p>
                    </div>
                </div>
            `;
            
            // Manejar tanto la estructura de data.productos como reporte.productos
            const productos = data.productos || reporte.productos || [];
            
            if (productos && productos.length > 0) {
                html += `
                    <div class="row">
                        <div class="col-12">
                            <h6><strong>Productos Afectados:</strong></h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Cantidad</th>
                                            <th>Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                productos.forEach(producto => {
                    const nombreProducto = producto.producto_nombre || producto.nombre;
                    const cantidad = producto.cantidad !== null && producto.cantidad !== undefined && producto.cantidad !== '' ? producto.cantidad : 'N/A';
                    html += `
                        <tr>
                            <td>${nombreProducto}</td>
                            <td>${cantidad}</td>
                            <td>${producto.observaciones || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="row">
                        <div class="col-12">
                            <p class="text-muted"><em>No hay productos asociados a este reporte.</em></p>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('contenidoDetalleReporte').innerHTML = html;
            new bootstrap.Modal(document.getElementById('modalDetalleReporte')).show();
        } else {
            showSwalError(data.message || 'No se pudo cargar el detalle del reporte.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSwalError(error.message || 'Ocurrió un error al cargar el detalle.');
    });
}

// Editar reporte
function editarReporte(reporteId) {
    fetch(`{% url "gestionar_reportes" %}?action=get&id=${reporteId}`)
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const reporte = data.reporte;
            console.log('Datos del reporte recibidos:', reporte);
            console.log('Nombre del reporte:', reporte.nombre);
            console.log('Nombre_reporte del reporte:', reporte.nombre_reporte);
            
            // Usar nombre_reporte como respaldo si nombre está vacío
            const nombreReporte = reporte.nombre || reporte.nombre_reporte || '';
            console.log('Nombre final a usar:', nombreReporte);
            
            document.getElementById('editReporteId').value = reporte.id;
            document.getElementById('editNombreReporte').value = nombreReporte;
            document.getElementById('editDescripcionReporte').value = reporte.descripcion;
            document.getElementById('editTipoReporte').value = reporte.tipo;
            
            mostrarCamposProductoEdit();
            
            // Cargar productos existentes
            const productosContainer = document.getElementById('productosContainerEdit');
            productosContainer.innerHTML = ''; // Limpiar contenedor
            
            if (data.productos && data.productos.length > 0) {
                data.productos.forEach((producto, index) => {
                    if (index === 0) {
                        // Crear el primer item
                        const firstItem = document.createElement('div');
                        firstItem.className = 'producto-item-edit mb-3 p-3 border rounded';
                        firstItem.innerHTML = `
                            <div class="row">
                                <div class="col-md-5">
                                    <label class="form-label">Producto</label>
                                    <select class="form-select producto-select-edit" name="productos_edit[]">
                                        <option value="">Seleccionar producto...</option>
                                        {% for producto in productos %}
                                        <option value="{{ producto.id }}" data-stock="{{ producto.stock }}">{{ producto.nombre }} (Stock: {{ producto.stock }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Cantidad</label>
                                    <input type="number" class="form-control cantidad-input-edit" name="cantidades_edit[]" min="1" placeholder="Cantidad">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Observaciones</label>
                                    <input type="text" class="form-control observaciones-input-edit" name="observaciones_edit[]" placeholder="Opcional">
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger btn-sm remove-producto-edit" onclick="removeProductoEdit(this)" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        productosContainer.appendChild(firstItem);
                        
                        // Establecer valores
                        firstItem.querySelector('.producto-select-edit').value = producto.id;
                        firstItem.querySelector('.cantidad-input-edit').value = producto.cantidad;
                        firstItem.querySelector('.observaciones-input-edit').value = producto.observaciones || '';
                    } else {
                        // Agregar items adicionales
                        addProductoEdit();
                        const items = productosContainer.querySelectorAll('.producto-item-edit');
                        const lastItem = items[items.length - 1];
                        lastItem.querySelector('.producto-select-edit').value = producto.id;
                        lastItem.querySelector('.cantidad-input-edit').value = producto.cantidad;
                        lastItem.querySelector('.observaciones-input-edit').value = producto.observaciones || '';
                    }
                });
            } else {
                // Si no hay productos, crear un item vacío
                const emptyItem = document.createElement('div');
                emptyItem.className = 'producto-item-edit mb-3 p-3 border rounded';
                emptyItem.innerHTML = `
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label">Producto</label>
                            <select class="form-select producto-select-edit" name="productos_edit[]">
                                <option value="">Seleccionar producto...</option>
                                {% for producto in productos %}
                                <option value="{{ producto.id }}" data-stock="{{ producto.stock }}">{{ producto.nombre }} (Stock: {{ producto.stock }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" class="form-control cantidad-input-edit" name="cantidades_edit[]" min="1" placeholder="Cantidad">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Observaciones</label>
                            <input type="text" class="form-control observaciones-input-edit" name="observaciones_edit[]" placeholder="Opcional">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm remove-producto-edit" onclick="removeProductoEdit(this)" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                productosContainer.appendChild(emptyItem);
            }
            
            updateRemoveButtonsEdit();
            updateRequiredFieldsEdit();
            
            new bootstrap.Modal(document.getElementById('modalEditarReporte')).show();
        } else {
            showSwalError(data.message || 'No se pudo cargar el reporte para editar.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSwalError(error.message || 'Ocurrió un error al cargar el reporte.');
    });
}

// Confirmar edición del reporte
function confirmarEditarReporte() {
    const nombreReporte = document.getElementById('editNombreReporte').value.trim();
    const descripcionReporte = document.getElementById('editDescripcionReporte').value.trim();
    const tipo = document.getElementById('editTipoReporte').value;
    
    // Las validaciones se manejan por el sistema de validación personalizado
    // Recopilar datos de productos
    const productos = [];
    if (tipo === 'perdida' || tipo === 'producto') {
        const productosContainer = document.getElementById('productosContainerEdit');
        const productosItems = productosContainer.querySelectorAll('.producto-item-edit');
        
        for (let item of productosItems) {
            const productoSelect = item.querySelector('.producto-select-edit');
            const cantidadInput = item.querySelector('.cantidad-input-edit');
            const observacionesInput = item.querySelector('.observaciones-input-edit');
            
            const productoId = productoSelect.value;
            const cantidad = cantidadInput.value;
            const observaciones = observacionesInput.value.trim();
            
            if (productoId && cantidad) {
                productos.push({
                    producto_id: productoId,
                    cantidad: parseInt(cantidad),
                    observaciones: observaciones
                });
            }
        }
    }
    
    const formData = {
        action: 'editar_reporte',
        reporte_id: document.getElementById('editReporteId').value,
        nombre_reporte: nombreReporte,
        descripcion: descripcionReporte,
        tipo: tipo,
        productos: productos
    };
    
    fetch('{% url "gestionar_reportes" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSwalSuccess(data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            if (data.error_type === 'unique_constraint') {
                showUniqueConstraintError(data.message, data.field);
            } else {
                showSwalError(data.message || 'Error al actualizar el reporte');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSwalError(error.message || 'Ocurrió un error al actualizar el reporte.');
    });
}

// Toggle estado del reporte
function toggleEstadoReporte(reporteId, estadoActual) {
    const nuevoEstado = !estadoActual;
    const accion = nuevoEstado ? 'activar' : 'desactivar';
    
    Swal.fire({
        title: `¿${accion.charAt(0).toUpperCase() + accion.slice(1)} reporte?`,
        text: `¿Está seguro que desea ${accion} este reporte?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, ' + accion,
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('{% url "gestionar_reportes" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    action: 'toggle_activo',
                    reporte_id: reporteId
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showSwalSuccess(data.message);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showSwalError(data.message || 'Error al cambiar el estado');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showSwalError(error.message || 'Ocurrió un error al cambiar el estado.');
            });
        }
    });
}

// Eliminar reporte
function eliminarReporte(reporteId) {
    Swal.fire({
        title: '¿Eliminar reporte?',
        text: 'Esta acción no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('{% url "gestionar_reportes" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    action: 'eliminar_reporte',
                    reporte_id: reporteId
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showSwalSuccess(data.message);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showSwalError(data.message || 'Error al eliminar el reporte');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showSwalError(error.message || 'Ocurrió un error al eliminar el reporte.');
            });
        }
    });
}
</script>
{% endblock %}