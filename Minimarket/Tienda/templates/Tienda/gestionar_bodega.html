{% extends 'Tienda/base_layout.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-warehouse me-2"></i>Gestión de Bodega - Mapa Interactivo</h2>
        <a href="{% url 'home' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver al Inicio
        </a>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Panel de Control</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-primary w-100 mb-2" onclick="crearSeccion()">
                            <i class="fas fa-plus me-1"></i> Crear Sección
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="toggleModoEdicion()">
                            <i class="fas fa-edit me-1"></i> <span id="modoEdicionText">Activar Edición</span>
                        </button>
                        <button class="btn btn-danger w-100" onclick="eliminarSeccionSeleccionada()">
                            <i class="fas fa-trash me-1"></i> Eliminar Seleccionada
                        </button>
                    </div>

                    <div id="infoSeccion" class="d-none">
                        <hr>
                        <h6><i class="fas fa-info-circle me-1"></i>Sección Seleccionada</h6>
                        <div class="mb-2">
                            <label class="form-label">Nombre:</label>
                            <input type="text" id="nombreSeccion" class="form-control form-control-sm">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Descripción:</label>
                            <textarea id="descripcionSeccion" class="form-control form-control-sm" rows="2"></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Color:</label>
                            <input type="color" id="colorSeccion" class="form-control form-control-color" oninput="actualizarColorEnTiempoReal()">
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Ancho:</label>
                                <input type="number" id="anchoSeccion" class="form-control form-control-sm" min="50" max="800" oninput="actualizarTamanoEnTiempoReal()">
                                <small class="text-muted">Máximo: 800px</small>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Alto:</label>
                                <input type="number" id="altoSeccion" class="form-control form-control-sm" min="50" max="580" oninput="actualizarTamanoEnTiempoReal()">
                                <small class="text-muted">Máximo: 580px</small>
                            </div>
                        </div>
                        <button class="btn btn-success btn-sm w-100 mt-2" onclick="actualizarSeccionSeleccionada()">
                            <i class="fas fa-save me-1"></i> Guardar Cambios
                        </button>
                        <button class="btn btn-primary btn-sm w-100 mt-1" onclick="mostrarLotesSeccion()">
                            <i class="fas fa-boxes me-1"></i> Ver Lotes Asignados
                        </button>
                    </div>

                    <hr>
                    <h6><i class="fas fa-boxes me-1"></i>Lotes Disponibles</h6>
                    <div id="lotesDisponibles" class="list-group" style="max-height: 200px; overflow-y: auto;">
                        {% for lote in lotes_disponibles %}
                        <div class="list-group-item list-group-item-action p-2"
                             draggable="true"
                             ondragstart="dragLote(event, {{ lote.id }}, '{{ lote.code_lote|escapejs }}')">
                            <small><strong>{{ lote.code_lote }}</strong><br>
                            {{ lote.proveedor.nombre_proveedor }}<br>
                            <span class="text-muted">{{ lote.fecha_registro|date:"d/m/Y" }}</span></small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card border-0 shadow-sm" style="width: 820px; height: 641px">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-map me-2"></i>Mapa de Bodega</h5>
                </div>
                <div id="mapaBodega" class="position-relative border border-secondary"
                    style="width: 820px; height: 641px; background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%), linear-gradient(-45deg, #f8f9fa 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f8f9fa 75%), linear-gradient(-45deg, transparent 75%, #f8f9fa 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; overflow: hidden;"
                    ondrop="dropLote(event)"
                    ondragover="allowDrop(event)"
                    onclick="if(event.target === this) deseleccionarSeccion()">

                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCrearSeccion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Crear Nueva Sección</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearSeccion" method="post" novalidate>
                    <div class="mb-3">
                        <label for="nombreNuevaSeccion" class="form-label">Nombre de la Sección <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nombreNuevaSeccion" name="nombreNuevaSeccion" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="descripcionNuevaSeccion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcionNuevaSeccion" name="descripcionNuevaSeccion" rows="3" maxlength="500"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="colorNuevaSeccion" class="form-label">Color</label>
                        <input type="color" class="form-control form-control-color" id="colorNuevaSeccion" name="colorNuevaSeccion" value="#3498db">
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label for="anchoNuevaSeccion" class="form-label">Ancho (px)</label>
                            <input type="number" class="form-control" id="anchoNuevaSeccion" name="anchoNuevaSeccion" value="120" min="60" max="800" required>
                            <small class="text-muted">Máximo: 800px</small>
                        </div>
                        <div class="col-6">
                            <label for="altoNuevaSeccion" class="form-label">Alto (px)</label>
                            <input type="number" class="form-control" id="altoNuevaSeccion" name="altoNuevaSeccion" value="80" min="40" max="580" required>
                            <small class="text-muted">Máximo: 580px</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="event.preventDefault(); confirmarCrearSeccion();">Crear Sección</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalLotesSeccion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-boxes me-2"></i>Lotes Asignados - <span id="nombreSeccionModal"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="listadoLotesSeccion"></div>
            </div>
        </div>
    </div>
</div>

<style>
.seccion-bodega:hover {
    opacity: 1 !important;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

.seccion-bodega.selected {
    border-color: #e74c3c !important;
    border-width: 3px !important;
    box-shadow: 0 0 15px rgba(231, 76, 60, 0.5);
}

.resize-handle {
    display: none;
    z-index: 10;
}

.seccion-bodega.selected .resize-handle {
    display: block;
}

.seccion-bodega.selected {
    resize: none !important;
}

.seccion-bodega:not(.selected) {
    resize: both;
}

/* Estilo para ver colisión en rojo */
.seccion-bodega.colliding {
    border-color: #ff0000 !important; /* Borde rojo */
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.7); /* Brillo */
    background-color: rgba(255, 0, 0, 0.3) !important; /* Semi-transparencia */
}

.list-group-item[draggable="true"]:hover {
    background-color: #e3f2fd;
    cursor: grab;
}

.list-group-item[draggable="true"]:active {
    cursor: grabbing;
}

#mapaBodega {
    border: 2px dashed #dee2e6;
}
</style>

<script>
let seccionSeleccionada = null;
let modoEdicion = true; // Activar modo edición por defecto
let seArrastra = false;
let estaRedimensionando = false;
let dragOffset = { x: 0, y: 0 };
let resizeHandle = null;
let tamanoInicio = { width: 0, height: 0 };
let mouseInicial = { x: 0, y: 0 };
const BODEGA_MARGEN = 10;

// Añadir variables para guardar la posición y tamaño original
let posicionOriginal = { x: 0, y: 0, width: 0, height: 0 };
let seccionModificada = false;

// Arreglo global para almacenar los datos de todas las secciones para detección de colisiones 
let DataDeTodasSecciones = [];

// Función auxiliar para detección de colisiones 
function VerificarColision(rect1, rect2) {
    return rect1.x < rect2.x + rect2.width &&
           rect1.x + rect1.width > rect2.x &&
           rect1.y < rect2.y + rect2.height &&
           rect1.y + rect1.height > rect2.y;
}

// Función para detectar colisones entre secciones
function VerificarColisionesEntreSecciones(currentSectionElement, newX, newY, newWidth, newHeight) {
    let colliding = false;
    const currentSectionId = currentSectionElement ? currentSectionElement.dataset.id : null;
    // Seleccionar todas las secciones que están actualmente en el DOM
    const allSectionElements = document.querySelectorAll('.seccion-bodega'); 

    for (const otherSectionElement of allSectionElements) {
        // Ignorar la sección que se está moviendo o redimensionando actualmente
        if (currentSectionId && otherSectionElement.dataset.id === currentSectionId) {
            continue; 
        }

        const rect1 = { x: newX, y: newY, width: newWidth, height: newHeight };
        const rect2 = {
            // Obtener la posición y el tamaño actuales de la otra sección directamente del estilo del DOM
            x: parseInt(otherSectionElement.style.left),
            y: parseInt(otherSectionElement.style.top),
            width: parseInt(otherSectionElement.style.width),
            height: parseInt(otherSectionElement.style.height)
        };

        if (VerificarColision(rect1, rect2)) {
            colliding = true;
            break;
        }
    }
    return colliding;
}

// Función para abrir el modal de crear sección
function crearSeccion() {
    // Limpiar formulario
    document.getElementById('formCrearSeccion').reset();
    document.getElementById('colorNuevaSeccion').value = '#3498db';
    document.getElementById('anchoNuevaSeccion').value = '120';
    document.getElementById('altoNuevaSeccion').value = '80';

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalCrearSeccion'));
    modal.show();
}

// Función para validar y crear la sección
function confirmarCrearSeccion() {
    // Validar formulario usando el sistema personalizado
    if (!validateSpecificForm('formCrearSeccion')) {
        return;
    }

    const nombre = document.getElementById('nombreNuevaSeccion').value;
    const descripcion = document.getElementById('descripcionNuevaSeccion').value;
    const color = document.getElementById('colorNuevaSeccion').value;
    const ancho = parseInt(document.getElementById('anchoNuevaSeccion').value);
    const alto = parseInt(document.getElementById('altoNuevaSeccion').value);

    // Validar que el nombre no sea solo espacios en blanco
    const nombreField = document.getElementById('nombreNuevaSeccion');
    if (nombre.trim() === '') {
        showValidationError('El nombre de la sección no puede estar vacío o contener solo espacios', nombreField);
        return;
    }

    // Validar caracteres especiales en el nombre
    if (!validateSpecialCharacters(nombreField)) {
        return;
    }

    // Obtener las dimensiones de la bodega
    const mapaBodega = document.getElementById('mapaBodega');
    const bodega_ancho = mapaBodega.offsetWidth;
    const bodega_alto = mapaBodega.offsetHeight;

     // Validar que la sección no sea más grande que el área usable de la bodega (con márgenes)
    if (ancho > (bodega_ancho - 2 * BODEGA_MARGEN)) {
        const anchoField = document.getElementById('anchoNuevaSeccion');
        showValidationError(`El ancho no puede exceder ${bodega_ancho - 2 * BODEGA_MARGEN}px (tamaño máximo usable de la bodega)`, anchoField);
        return;
    }

    if (alto > (bodega_alto - 2 * BODEGA_MARGEN)) {
        const altoField = document.getElementById('altoNuevaSeccion');
        showValidationError(`El alto no puede exceder ${bodega_alto - 2 * BODEGA_MARGEN}px (tamaño máximo usable de la bodega)`, altoField);
        return;
    }

    let newX = BODEGA_MARGEN; // Iniciar búsqueda desde el margen
    let newY = BODEGA_MARGEN; // Iniciar búsqueda desde el margen
    const placementAttempts = 100;
    const internalSpacing = 10; // Espacio entre secciones al intentar colocarlas en la cuadrícula

    let foundEmptySpot = false;
    for (let i = 0; i < placementAttempts; i++) {
        // Calcular el área usable para la colocación, restando el doble del margen de bodega
        const usableWidth = bodega_ancho - (2 * BODEGA_MARGEN);
        const usableHeight = bodega_alto - (2 * BODEGA_MARGEN);

        const cols = Math.floor(usableWidth / (ancho + internalSpacing));
        const rows = Math.floor(usableHeight / (alto + internalSpacing));

        if (cols <= 0 || rows <= 0) {
            break; // No hay espacio suficiente para la sección con el margen y el espaciado
        }

        const colIndex = i % cols;
        const rowIndex = Math.floor(i / cols) % rows;

        // Proponer una posición dentro del área usable, empezando desde el margen
        let proposedX = BODEGA_MARGEN + colIndex * (ancho + internalSpacing);
        let proposedY = BODEGA_MARGEN + rowIndex * (alto + internalSpacing);

        // Asegurarse de que la posición propuesta más el tamaño esté dentro de los límites del margen
        if (proposedX + ancho > bodega_ancho - BODEGA_MARGEN) {
            proposedX = bodega_ancho - ancho - BODEGA_MARGEN;
        }
        if (proposedY + alto > bodega_alto - BODEGA_MARGEN) {
            proposedY = bodega_alto - alto - BODEGA_MARGEN;
        }

        const proposedRect = { x: proposedX, y: proposedY, width: ancho, height: alto };

        // Comprobar colisión con otras secciones (se pasa null porque es una sección nueva)
        if (!VerificarColisionesEntreSecciones(null, proposedRect.x, proposedRect.y, proposedRect.width, proposedRect.height)) {
            foundEmptySpot = true;
            newX = proposedRect.x;
            newY = proposedRect.y;
            break;
        }
    }

    if (!foundEmptySpot) {
        const nombreField = document.getElementById('nombreNuevaSeccion');
        showValidationError('No se encontró un espacio vacío para la nueva sección dentro de los márgenes de la bodega. Intenta ajustar las secciones existentes o prueba un tamaño diferente.', nombreField);
        return;
    }

    const data = {
        nombre: nombre.trim(),
        descripcion: descripcion.trim(),
        tipo_forma: 'rectangulo',
        posicion_x: newX,
        posicion_y: newY,
        ancho: ancho,
        alto: alto,
        color: color
    };

    fetch('{% url "crear_seccion" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        // Comprobar si la respuesta es correcta (estado 200-299)
        if (!response.ok) {
            // Intentar analizar el mensaje de error JSON si está disponible, de lo contrario usar el texto de respuesta
            return response.json().then(errorData => {
                throw new Error(errorData.error || 'Error desconocido del servidor');
            }).catch(() => {
                // Si el análisis como JSON falla, podría no ser una respuesta JSON (ej. página de error HTML)
                return response.text().then(text => {
                    throw new Error(`Error en la respuesta del servidor (Status: ${response.status}): ${text.substring(0, 200)}...`);
                });
            });
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCrearSeccion'));
            modal.hide();

            // Recargar secciones dinámicamente
            cargarSecciones();

            // Mostrar mensaje de éxito con SweetAlert2
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: 'Sección creada correctamente',
                confirmButtonColor: '#28a745',
                timer: 2000,
                showConfirmButton: false
            });
        } else {
            const nombreField = document.getElementById('nombreNuevaSeccion');
            const errorMessage = result.error || 'Error desconocido';
            
            // Verificar si es un error de unique constraint
            if (isUniqueConstraintError(errorMessage)) {
                showUniqueConstraintError('seccionbodega_nombre', nombreField);
            } else {
                showValidationError('Error al crear la sección: ' + errorMessage, nombreField);
            }
        }
    })
    .catch(error => {
        console.error('Fetch error:', error); 
        const nombreField = document.getElementById('nombreNuevaSeccion');
        showValidationError('No se pudo conectar con el servidor o hubo un error inesperado: ' + error.message, nombreField);
    });
}

// Funció para seleccionar una sección
function seleccionarSeccion(event, elemento) {
    event.stopPropagation();

    // Deseleccionar sección anterior sin restaurar su posición
    if (seccionSeleccionada) {
        seccionSeleccionada.classList.remove('selected');
        seccionSeleccionada.classList.remove('colliding');
    }

    // Seleccionar nueva sección
    seccionSeleccionada = elemento;
    elemento.classList.add('selected');

    // Mostrar información en el panel
    actualizarPanelInformacion();
}

// función para restaurar la posición original de una sección
function restaurarPosicionOriginal() {
    if (!seccionSeleccionada) return;
    
    // Restaurar posición y tamaño originales
    seccionSeleccionada.style.left = posicionOriginal.x + 'px';
    seccionSeleccionada.style.top = posicionOriginal.y + 'px';
    seccionSeleccionada.style.width = posicionOriginal.width + 'px';
    seccionSeleccionada.style.height = posicionOriginal.height + 'px';
    
    // Quitar clase de colisión si existe
    seccionSeleccionada.classList.remove('colliding');
    
    // Reiniciar el estado de modificación
    seccionModificada = false;
}

// Actualizar información en el panel
function actualizarPanelInformacion() {
    if (!seccionSeleccionada) return;

    document.getElementById('infoSeccion').classList.remove('d-none');
    document.getElementById('nombreSeccion').value = seccionSeleccionada.dataset.nombre;
    document.getElementById('descripcionSeccion').value = seccionSeleccionada.dataset.descripcion;
    document.getElementById('colorSeccion').value = seccionSeleccionada.dataset.color;
    document.getElementById('anchoSeccion').value = parseInt(seccionSeleccionada.style.width) || 100;
    document.getElementById('altoSeccion').value = parseInt(seccionSeleccionada.style.height) || 100;

}

// Función para deseleccionar una sección
function deseleccionarSeccion() {
    if (seccionSeleccionada) {
        seccionSeleccionada.classList.remove('selected');
        seccionSeleccionada.classList.remove('colliding');
        seccionSeleccionada = null;
        document.getElementById('infoSeccion').classList.add('d-none');
    }
}

// Función para actualizar el color en tiempo real
function actualizarColorEnTiempoReal() {
    if (!seccionSeleccionada) return;
    const nuevoColor = document.getElementById('colorSeccion').value;
    seccionSeleccionada.style.backgroundColor = nuevoColor;
    seccionSeleccionada.dataset.color = nuevoColor;
}

// Función para actualizar tamaño en tiempo real
function actualizarTamanoEnTiempoReal() {
    if (!seccionSeleccionada) return;

    const inputAncho = document.getElementById('anchoSeccion');
    const inputAlto = document.getElementById('altoSeccion');

    let nuevoAncho = parseInt(inputAncho.value);
    let nuevoAlto = parseInt(inputAlto.value);

    // Obtener la posición actual de la sección seleccionada
    const actualX= parseInt(seccionSeleccionada.style.left);
    const actualY = parseInt(seccionSeleccionada.style.top);

    // Obtener las dimensiones de la bodega
    const mapaBodega = document.getElementById('mapaBodega');
    const bodega_ancho = mapaBodega.offsetWidth;
    const bodega_alto = mapaBodega.offsetHeight;

    // Prevenir que exceda los límites de la bodega con margen 
    // Ancho y alto máximos permitidos, considerando la posición actual y el margen de la bodega
    const AnchoMaximoPermitido = bodega_ancho - actualX- BODEGA_MARGEN;
    const AltoMaximoPermitido = bodega_alto - actualY - BODEGA_MARGEN;

    // Ajustar el nuevo ancho/alto para que no exceda los límites permitidos ni los mínimos del input
    nuevoAncho = Math.max(parseInt(inputAncho.min), Math.min(nuevoAncho, AnchoMaximoPermitido));
    nuevoAlto = Math.max(parseInt(inputAlto.min), Math.min(nuevoAlto, AltoMaximoPermitido));

    let puedeAplicarAncho = true;
    let puedeAplicarAlto = true;

    // Obtener dimensiones visuales actuales para la comprobación de colisión si una dimensión no cambia
    const AnchoVisualActual = parseInt(seccionSeleccionada.style.width);
    const AltoVisualActual = parseInt(seccionSeleccionada.style.height);

    // Comprobación de colisión con otras secciones
    const estaColisionando = VerificarColisionesEntreSecciones(seccionSeleccionada, actualX, actualY, nuevoAncho, nuevoAlto);

    if (!estaColisionando) {
        seccionSeleccionada.style.width = nuevoAncho + 'px';
        seccionSeleccionada.style.height = nuevoAlto + 'px';
        seccionSeleccionada.classList.remove('colliding');
    } else {
        seccionSeleccionada.classList.add('colliding');
    }

    // Actualizar los valores de los inputs si fueron ajustados
    // Esto asegura que el número en el formulario refleje el tamaño real aplicado
    if (parseInt(inputAncho.value) !== nuevoAncho) {
        inputAncho.value = nuevoAncho;
    }
    if (parseInt(inputAlto.value) !== nuevoAlto) {
        inputAlto.value = nuevoAlto;
    }
}

// Actualizar la sección seleccionada en tiempo real
function actualizarSeccionSeleccionada() {
    if (!seccionSeleccionada) {
        Swal.fire({
            icon: 'warning',
            title: 'Atención',
            text: 'Por favor selecciona una sección primero',
            confirmButtonColor: '#f39c12'
        });
        return;
    }

    // Evitar guardar si la sección está en estado de colisión
    if (seccionSeleccionada.classList.contains('colliding')) {
        const nombreField = document.getElementById('nombreSeccion');
        showValidationError('La sección no se puede guardar porque está colisionando con otra sección.', nombreField);
        return;
    }

    const nombre = document.getElementById('nombreSeccion').value;
    const ancho = parseInt(document.getElementById('anchoSeccion').value);
    const alto = parseInt(document.getElementById('altoSeccion').value);
    const pos_x = parseInt(seccionSeleccionada.style.left.replace('px', '')) || 0;
    const pos_y = parseInt(seccionSeleccionada.style.top.replace('px', '')) || 0;

    // Validar que el nombre no sea solo espacios en blanco
    const nombreField = document.getElementById('nombreSeccion');
    if (nombre.trim() === '') {
        showValidationError('El nombre de la sección no puede estar vacío o contener solo espacios', nombreField);
        return;
    }

    // Validar caracteres especiales en el nombre
    if (!validateSpecialCharacters(nombreField)) {
        return;
    }

    const data = {
        nombre: nombre.trim(),
        descripcion: document.getElementById('descripcionSeccion').value.trim(),
        color: document.getElementById('colorSeccion').value,
        ancho: ancho,
        alto: alto,
        posicion_x: pos_x,
        posicion_y: pos_y
    };

    fetch(`{% url 'actualizar_seccion' 0 %}`.replace('0', seccionSeleccionada.dataset.id), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Error en la respuesta del servidor'); });
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            // Verificar que la sección aún existe antes de actualizar
            if (seccionSeleccionada && seccionSeleccionada.parentNode) {
                // Actualizar solo los datos del dataset, mantener la posición visual actual
                const spanElement = seccionSeleccionada.querySelector('span');
                if (spanElement) {
                    spanElement.textContent = data.nombre;
                }
                seccionSeleccionada.dataset.nombre = data.nombre;
                seccionSeleccionada.dataset.descripcion = data.descripcion;
                seccionSeleccionada.dataset.color = data.color;
                // Actualizar color de fondo
                seccionSeleccionada.style.backgroundColor = data.color;

                // Actualizar DatosDeTodasSecciones despues de guardar
                const updatedIndex = DatosDeTodasSecciones.findIndex(s => s.id == seccionSeleccionada.dataset.id);
                if (updatedIndex !== -1) {
                    DatosDeTodasSecciones[updatedIndex] = {
                        id: parseInt(seccionSeleccionada.dataset.id),
                        x: pos_x,
                        y: pos_y,
                        width: ancho,
                        height: alto
                    };
                }
                
                // Reiniciar el estado de modificación después de guardar
                seccionModificada = false;
                
                // Actualizar la posición original con los nuevos valores guardados
                posicionOriginal.x = pos_x;
                posicionOriginal.y = pos_y;
                posicionOriginal.width = ancho;
                posicionOriginal.height = alto;

                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: 'Cambios guardados correctamente',
                    confirmButtonColor: '#28a745',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                const nombreField = document.getElementById('nombreSeccion');
                showValidationError('Error: La sección no se pudo actualizar', nombreField);
            }
        } else {
            const nombreField = document.getElementById('nombreSeccion');
            const errorMessage = result.error || 'Error desconocido';
            
            // Verificar si es un error de unique constraint
            if (isUniqueConstraintError(errorMessage)) {
                showUniqueConstraintError('seccionbodega_nombre', nombreField);
            } else {
                showValidationError('Error al actualizar la sección: ' + errorMessage, nombreField);
            }
        }
    })
    .catch(error => {
        const nombreField = document.getElementById('nombreSeccion');
        showValidationError('No se pudo conectar con el servidor o hubo un error inesperado: ' + error.message, nombreField);
    });
}

// Función para eliminar una sección seleccionada
function eliminarSeccionSeleccionada() {
    if (!seccionSeleccionada) {
        const mapaBodega = document.getElementById('mapaBodega');
        showValidationError('Selecciona una sección para eliminar', mapaBodega);
        return;
    }

    Swal.fire({
        title: '¿Estás seguro?',
        text: '¿Quieres eliminar esta sección?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
        fetch(`{% url 'eliminar_seccion' 0 %}`.replace('0', seccionSeleccionada.dataset.id), {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                DatosDeTodasSecciones = DatosDeTodasSecciones.filter(s => s.id != seccionSeleccionada.dataset.id);

                seccionSeleccionada.remove();
                deseleccionarSeccion();
                
                // Mostrar mensaje de éxito
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: 'Sección eliminada correctamente',
                    confirmButtonColor: '#28a745',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                const mapaBodega = document.getElementById('mapaBodega');
                showValidationError('Error al eliminar la sección: ' + (result.error || 'Error desconocido'), mapaBodega);
            }
        })
        .catch(error => {
            const mapaBodega = document.getElementById('mapaBodega');
            showValidationError('Error al eliminar la sección: ' + error.message, mapaBodega);
        });
        }
    });
}

// Función para cambiar el modo de edición
function toggleModoEdicion() {
    modoEdicion = !modoEdicion;
    const texto = document.getElementById('modoEdicionText');
    texto.textContent = modoEdicion ? 'Desactivar Edición' : 'Activar Edición';

    // Activar o desactivar arrastre según el modo
    const secciones = document.querySelectorAll('.seccion-bodega');
    secciones.forEach(seccion => {
        if (modoEdicion) {
            habilitarArrastre(seccion);
        } else {
            deshabilitarArrastre(seccion);
        }
    });
    // Deseleccionar sección si se desactiva el modo de edición
    if (!modoEdicion && seccionSeleccionada) {
        deseleccionarSeccion();
    }
}

// Funciones de agarre y redimensionamiento
function habilitarArrastre(elemento) {
    elemento.addEventListener('mousedown', iniciarArrastre);
}

function deshabilitarArrastre(elemento) {
    elemento.removeEventListener('mousedown', iniciarArrastre);
}

function iniciarArrastre(e) {
    if (!modoEdicion) return;

    // Verifica si el clic fue en el handle de redimensionamiento
    if (e.target.classList.contains('resize-handle')) {
        iniciarRedimensionamiento(e);
        return;
    }

    seArrastra = true;

    // Deseleccionar la sección anterior si existe
    if (seccionSeleccionada && seccionSeleccionada !== this && seccionModificada) {
        restaurarPosicionOriginal();
    }

    // Seleccionar la sección actual
    seccionSeleccionada = this;
    this.classList.add('selected');

    // Guardar la posición original antes de mover (siempre guardar al iniciar)
    posicionOriginal.x = parseInt(this.style.left);
    posicionOriginal.y = parseInt(this.style.top);
    posicionOriginal.width = parseInt(this.style.width);
    posicionOriginal.height = parseInt(this.style.height);
    seccionModificada = true;

    // Mostrar información en el panel
    document.getElementById('infoSeccion').classList.remove('d-none');
    document.getElementById('nombreSeccion').value = this.dataset.nombre;
    document.getElementById('descripcionSeccion').value = this.dataset.descripcion;
    document.getElementById('colorSeccion').value = this.dataset.color;
    document.getElementById('anchoSeccion').value = parseInt(this.style.width) || 100;
    document.getElementById('altoSeccion').value = parseInt(this.style.height) || 100;

    const rect = this.getBoundingClientRect();
    const mapRect = document.getElementById('mapaBodega').getBoundingClientRect();

    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;

    document.addEventListener('mousemove', arrastrar);
    document.addEventListener('mouseup', terminarArrastre);

    e.preventDefault();
}

// Funcion para redimensionar
function arrastrar(e) {
    if (!seArrastra || !seccionSeleccionada) return;

    const mapRect = document.getElementById('mapaBodega').getBoundingClientRect();
    const newX_unclamped = e.clientX - mapRect.left - dragOffset.x;
    const newY_unclamped = e.clientY - mapRect.top - dragOffset.y;

    const anchoActual = parseInt(seccionSeleccionada.style.width);
    const altoActual = parseInt(seccionSeleccionada.style.height);

    const minX = BODEGA_MARGEN;
    const minY = BODEGA_MARGEN;
    const maxX = mapRect.width - anchoActual - BODEGA_MARGEN;
    const maxY = mapRect.height - altoActual - BODEGA_MARGEN;

    const newX = Math.max(minX, Math.min(newX_unclamped, maxX));
    const newY = Math.max(minY, Math.min(newY_unclamped, maxY));

    const estaColisionando = VerificarColisionesEntreSecciones(seccionSeleccionada, newX, newY, anchoActual, altoActual);

    if (!estaColisionando) {
        seccionSeleccionada.style.left = newX + 'px';
        seccionSeleccionada.style.top = newY + 'px';
        seccionSeleccionada.classList.remove('colliding');
    } else {
        seccionSeleccionada.classList.add('colliding');
    }

    // Actualizar datos en el panel
    if (!document.getElementById('infoSeccion').classList.contains('d-none')) {
        document.getElementById('anchoSeccion').value = anchoActual;
        document.getElementById('altoSeccion').value = altoActual;
    }
}

function terminarArrastre() {
    // Solo actualizar en el panel, no guardar
    if ((seArrastra || estaRedimensionando) && seccionSeleccionada) {
        if (seccionSeleccionada.classList.contains('colliding')) {
        }
        actualizarPanelInformacion(); // 
        // Mantener el estado de modificación como true para que se restaure
        // solo cuando se seleccione otra sección
        seccionModificada = true;
    }
    seArrastra = false;
    estaRedimensionando = false;
    resizeHandle = null;
    document.removeEventListener('mousemove', arrastrar);
    document.removeEventListener('mousemove', redimensionar);
    document.removeEventListener('mouseup', terminarArrastre);
}

// Funciones de redimensionamiento
function iniciarRedimensionamiento(e) {
    if (!modoEdicion) return;

    estaRedimensionando = true;
    resizeHandle = e.target;

    const seccion = e.target.closest('.seccion-bodega');
    if (seccion) {
        // deseleccionar la sección anterior y volver a la posición original
        if (seccionSeleccionada && seccionSeleccionada !== seccion && seccionModificada) {
            restaurarPosicionOriginal();
        }

        seccionSeleccionada = seccion;
        seccion.classList.add('selected');

        // Guardar la posición y tamaño original antes de redimensionar (siempre guardar al iniciar)
        posicionOriginal.x = parseInt(seccion.style.left);
        posicionOriginal.y = parseInt(seccion.style.top);
        posicionOriginal.width = parseInt(seccion.style.width);
        posicionOriginal.height = parseInt(seccion.style.height);
        seccionModificada = true;

        tamanoInicio.width = parseInt(seccion.style.width);
        tamanoInicio.height = parseInt(seccion.style.height);
        mouseInicial.x = e.clientX;
        mouseInicial.y = e.clientY;

        document.addEventListener('mousemove', redimensionar);
        document.addEventListener('mouseup', terminarArrastre);
    }

    e.preventDefault();
    e.stopPropagation();
}
// Funcion para redimensionar
function redimensionar(e) {
    if (!estaRedimensionando || !seccionSeleccionada || !resizeHandle) return;

    const deltaX = e.clientX - mouseInicial.x;
    const deltaY = e.clientY - mouseInicial.y;

    let newWidth = tamanoInicio.width;
    let newHeight = tamanoInicio.height;

    if (resizeHandle.classList.contains('resize-se')) {
        // Redimensionar desde la esquina inferior derecha
        newWidth = Math.max(60, tamanoInicio.width + deltaX);
        newHeight = Math.max(40, tamanoInicio.height + deltaY);
    } else if (resizeHandle.classList.contains('resize-s')) {
        // Redimensionar solo la altura desde la parte inferior
        newHeight = Math.max(40, tamanoInicio.height + deltaY);
    } else if (resizeHandle.classList.contains('resize-e')) {
        // Redimensionar solo el ancho desde la derecha
        newWidth = Math.max(60, tamanoInicio.width + deltaX);
    }

    // Límites de la bodega con margen 
    const mapRect = document.getElementById('mapaBodega').getBoundingClientRect();
    const mapLeft = parseInt(seccionSeleccionada.style.left);
    const mapTop = parseInt(seccionSeleccionada.style.top);

    // Ancho/alto máximo permitido, considerando el margen derecho/inferior
    const AnchoMaximoPermitido = mapRect.width - mapLeft - BODEGA_MARGEN;
    const AltoMaximoPermitido = mapRect.height - mapTop - BODEGA_MARGEN;

    newWidth = Math.min(newWidth, AnchoMaximoPermitido);
    newHeight = Math.min(newHeight, AltoMaximoPermitido);

    const estaColisionando = VerificarColisionesEntreSecciones(seccionSeleccionada, mapLeft, mapTop, newWidth, newHeight);

    if (!estaColisionando) {
        seccionSeleccionada.style.width = newWidth + 'px';
        seccionSeleccionada.style.height = newHeight + 'px';
        seccionSeleccionada.classList.remove('colliding');
    } else {
        seccionSeleccionada.classList.add('colliding');
    }

    if (!document.getElementById('infoSeccion').classList.contains('d-none')) {
        document.getElementById('anchoSeccion').value = parseInt(seccionSeleccionada.style.width); // Actualizar con el visual actual
        document.getElementById('altoSeccion').value = parseInt(seccionSeleccionada.style.height); // Actualizar con el visual actual
    }
}


// Arrastrar y soltar lote
function dragLote(event, loteId, loteCodigo) {
    event.dataTransfer.setData('loteId', loteId);
    event.dataTransfer.setData('loteCodigo', loteCodigo);
}

function allowDrop(event) {
    event.preventDefault();
}

function dropLote(event) {
    event.preventDefault();
    // Si el lote cae en otro lugar que no sea una seccion, no hacer nada
}

function dropLoteEnSeccion(event, seccionId) {
    event.preventDefault();
    event.stopPropagation();

    const loteId = event.dataTransfer.getData('loteId');
    const loteCodigo = event.dataTransfer.getData('loteCodigo');

    if (loteId) {
        Swal.fire({
            title: '¿Asignar lote?',
            text: `¿Asignar el lote ${loteCodigo} a esta sección?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, asignar',
            cancelButtonText: 'Cancelar',
            input: 'textarea',
            inputPlaceholder: 'Observaciones (opcional)...'
        }).then((result) => {
            if (result.isConfirmed) {
                const observaciones = result.value || '';


        fetch('{% url "asignar_lote_seccion" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                seccion_id: seccionId,
                lote_id: loteId,
                observaciones: observaciones
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: 'Lote asignado correctamente',
                    confirmButtonColor: '#28a745',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al asignar el lote: ' + (result.error || 'Error desconocido'),
                    confirmButtonColor: '#e74c3c'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al asignar el lote: ' + error.message,
                confirmButtonColor: '#e74c3c'
            });
        });
            }
        });
    }
}

// Función para mostrar los lotes de una sección
function mostrarLotesSeccion() {
    if (!seccionSeleccionada) return;

    const seccionId = seccionSeleccionada.dataset.id;
    const nombreSeccion = seccionSeleccionada.dataset.nombre;

    fetch(`{% url 'obtener_lotes_seccion' 0 %}`.replace('0', seccionId), {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            document.getElementById('nombreSeccionModal').textContent = nombreSeccion;

            let html = '';
            if (result.lotes.length === 0) {
                html = '<p class="text-muted">No hay lotes asignados a esta sección.</p>';
            } else {
                html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Código Lote</th><th>Proveedor</th><th>Fecha Registro</th><th>Fecha Asignación</th><th>Observaciones</th><th>Acciones</th></tr></thead><tbody>';

                result.lotes.forEach(lote => {
                    html += `<tr>
                        <td><strong>${lote.lote_codigo}</strong></td>
                        <td>${lote.proveedor}</td>
                        <td>${lote.fecha_registro}</td>
                        <td>${lote.fecha_asignacion}</td>
                        <td>${lote.observaciones}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="desasignarLote(${lote.asignacion_id})"><i class="fas fa-unlink"></i></button></td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
            }

            document.getElementById('listadoLotesSeccion').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('modalLotesSeccion'));
            modal.show();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al obtener los lotes: ' + (result.error || 'Error desconocido'),
                confirmButtonColor: '#e74c3c'
            });
        }
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al obtener los lotes: ' + error.message,
            confirmButtonColor: '#e74c3c'
        });
    });
}

// Funcción para desasignar un lote
function desasignarLote(asignacionId) {
    Swal.fire({
        title: '¿Estás seguro?',
        text: '¿Quieres desasignar este lote?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, desasignar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
        fetch(`{% url 'desasignar_lote_seccion' 0 %}`.replace('0', asignacionId), {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: 'Lote desasignado correctamente',
                    confirmButtonColor: '#28a745',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    mostrarLotesSeccion(); 
                    setTimeout(() => location.reload(), 1000); 
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al desasignar el lote: ' + (result.error || 'Error desconocido'),
                    confirmButtonColor: '#e74c3c'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al desasignar el lote: ' + error.message,
                confirmButtonColor: '#e74c3c'
            });
        });
        }
    });
}

// Función para obtener CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para cargar las secciones desde el servidor
function cargarSecciones() {
    fetch('{% url "obtener_secciones" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            const mapaBodega = document.getElementById('mapaBodega');

            // Borrar secciones existentes
            const seccionesExistentes = mapaBodega.querySelectorAll('.seccion-bodega');
            seccionesExistentes.forEach(seccion => seccion.remove());

            // Borrar todas las secciones existentes 
            DatosDeTodasSecciones = [];

            // Añadir cada seccion una a una
            result.secciones.forEach(seccionData => {
                crearElementoSeccion(seccionData);
                DatosDeTodasSecciones.push({
                    id: seccionData.id,
                    x: seccionData.posicion_x,
                    y: seccionData.posicion_y,
                    width: seccionData.ancho,
                    height: seccionData.alto
                });
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al cargar las secciones: ' + (result.error || 'Error desconocido'),
                confirmButtonColor: '#e74c3c'
            });
        }
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al cargar las secciones: ' + error.message,
            confirmButtonColor: '#e74c3c'
        });
    });
}

// Funcion para crear un elemento de sección
function crearElementoSeccion(seccionData) {
    const mapaBodega = document.getElementById('mapaBodega');

    const seccionElement = document.createElement('div');
    seccionElement.className = 'seccion-bodega';
    seccionElement.dataset.id = seccionData.id;
    seccionElement.dataset.nombre = seccionData.nombre;
    seccionElement.dataset.descripcion = seccionData.descripcion;
    seccionElement.dataset.tipo = seccionData.tipo_forma;
    seccionElement.dataset.color = seccionData.color;

    seccionElement.style.cssText = `
        position: absolute;
        left: ${seccionData.posicion_x}px;
        top: ${seccionData.posicion_y}px;
        width: ${seccionData.ancho}px;
        height: ${seccionData.alto}px;
        background-color: ${seccionData.color};
        border: 2px solid #2c3e50;
        border-radius: 6px;
        cursor: move;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        user-select: none;
        opacity: 0.8;
        resize: both;
        overflow: hidden;
        min-width: 60px;
        min-height: 40px;
        z-index: 1; /* Ensure sections are above the grid but below handles */
    `;

    seccionElement.onclick = function(event) {
        seleccionarSeccion(event, this);
    };

    seccionElement.ondrop = function(event) {
        dropLoteEnSeccion(event, seccionData.id);
    };

    seccionElement.ondragover = allowDrop;

    const span = document.createElement('span');
    span.textContent = seccionData.nombre;
    seccionElement.appendChild(span);

    const handleSE = document.createElement('div');
    handleSE.className = 'resize-handle resize-se';
    handleSE.style.cssText = 'position: absolute; bottom: -6px; right: -6px; width: 12px; height: 12px; background: #e74c3c; cursor: se-resize; border-radius: 0 0 4px 0; z-index: 10;'; // Z-index higher
    seccionElement.appendChild(handleSE);

    const handleS = document.createElement('div');
    handleS.className = 'resize-handle resize-s';
    handleS.style.cssText = 'position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 12px; height: 6px; background: #e74c3c; cursor: s-resize; z-index: 10;'; // Z-index higher
    seccionElement.appendChild(handleS);

    const handleE = document.createElement('div');
    handleE.className = 'resize-handle resize-e';
    handleE.style.cssText = 'position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 6px; height: 12px; background: #e74c3c; cursor: e-resize; z-index: 10;'; // Z-index higher
    seccionElement.appendChild(handleE);

    // añadir a la bodega
    mapaBodega.appendChild(seccionElement);

    // Habilitar arrastre de secciones
    habilitarArrastre(seccionElement);
}

document.addEventListener('DOMContentLoaded', function() {
    cargarSecciones();

    const texto = document.getElementById('modoEdicionText');
    if (texto) {
        texto.textContent = modoEdicion ? 'Desactivar Edición' : 'Activar Edición';
    }
    if (typeof bootstrap === 'undefined') {
    }
});
</script>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/custom-validation.js' %}"></script>
{% endblock %}